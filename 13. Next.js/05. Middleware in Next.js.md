## Middleware in Next.js

### What is Middleware?

Middleware lets you run custom logic before a request is completed.

It intercepts requests and can:

- Modify the request/response
- Redirect or rewrite URLs
- Add headers
- Handle authentication/authorization

Runs before the request reaches the actual page or API route.

Introduced in Next.js 12 and works in both Pages Router and App Router.

---

### How It Works

- Middleware files live at the root as `middleware.js` or `middleware.ts`.
- Uses the Edge Runtime — lightweight, fast, runs on CDN edge locations.
- Runs on every matched request (page, API, static asset) unless filtered.

---

### Basic Example

```js
// middleware.js
import { NextResponse } from 'next/server';

export function middleware(req) {
  const token = req.cookies.get('token');

  if (!token && req.nextUrl.pathname.startsWith('/dashboard')) {
    return NextResponse.redirect(new URL('/login', req.url));
  }

  return NextResponse.next(); // continue to requested page
}

// Only run middleware on certain routes
export const config = {
  matcher: ['/dashboard/:path*'],
};
```

**What happens here:**

- If the user tries to access `/dashboard` without a token, redirect to `/login`.
- Otherwise, allow the request.

---

### Common Use Cases

- Authentication & Authorization — Check cookies/session before serving page.
- A/B Testing — Serve different content to different users.
- Geolocation-based redirects — Show region-specific pages.
- Internationalization — Redirect users to language-specific routes.
- Custom headers — Add security headers globally.

---

### Key Points for Senior-Level Understanding

- **Edge Runtime limitations:**
  - No full Node.js APIs (e.g., `fs`, `net`, some crypto methods)
  - Must be small and fast (runs on edge)
- **Performance:** Runs globally but should remain lightweight.
- **Security:** Good place to block malicious requests before they hit your app.

---

### Common Interview Questions

- What is Middleware in Next.js and when does it run?
- How do you restrict Middleware to specific routes?
- What’s the difference between Middleware and API Routes?
- Why does Middleware use the Edge Runtime instead of Node.js?
- How would you implement auth checks using Middleware?
